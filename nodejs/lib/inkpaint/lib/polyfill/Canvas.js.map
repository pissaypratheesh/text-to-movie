{"version":3,"file":"Canvas.js","names":["PSCanvas","poly","Canvas","constructor","width","height","type","_event","EventEmitter","_glResizeExt","_gl","_renderType","useTypedArray","isPSCanvas","id","uuidvx","getContext","options","ctx","gl","GLFix","fixGetUniformLocation","fixTexImage2D","getExtension","_ctx","value","resize","clientWidth","clientHeight","addEventListener","listener","addListener","removeEventListener","removeListener","removeAllListeners","_putImageData","data","pixels","Uint8Array","readPixels","RGBA","UNSIGNED_BYTE","createImageData","Uint8ClampedArray","getImageData","_fillImageData","putImageData","i","j","col","row","k","idx","idx2","toBuffer","toDataURL","createPNGStream","createJPEGStream","createPDFStream","destroy"],"sources":["../../src/polyfill/Canvas.js"],"sourcesContent":["import { gl, Canvas, createImageData } from \"../canvas-gl\";\nimport poly from \"./poly\";\nimport GLFix from \"./glfix\";\nimport { uuidvx } from \"../utils\";\nimport EventEmitter from \"eventemitter3\";\n\nexport default class PSCanvas extends poly(Canvas) {\n  constructor(width, height, type) {\n    super(width, height, type);\n\n    this._event = new EventEmitter();\n    this._glResizeExt = null;\n    this._gl = null;\n    this._renderType = \"2d\";\n    this.useTypedArray = false;\n    this.isPSCanvas = true;\n    this.id = uuidvx();\n  }\n\n  // Get canvas context\n  getContext(type, options) {\n    this._renderType = type;\n\n    if (type === \"webgl\") {\n      if (this._gl) return this._gl;\n\n      const { width, height } = this;\n      const ctx = gl(width, height, options);\n      GLFix.fixGetUniformLocation(ctx);\n      GLFix.fixTexImage2D(ctx);\n\n      this._gl = ctx;\n      this._glResizeExt = ctx.getExtension(\"STACKGL_resize_drawingbuffer\");\n      this._ctx = super.getContext(\"2d\", options);\n      return this._gl;\n    }\n\n    return super.getContext(type, options);\n  }\n\n  // Canvas Reset width and height\n  get height() {\n    return super.height;\n  }\n\n  set height(value) {\n    if (this._glResizeExt) this._glResizeExt.resize(this.width, value);\n    super.height = value;\n  }\n\n  get width() {\n    return super.width;\n  }\n\n  set width(value) {\n    if (this._glResizeExt) this._glResizeExt.resize(value, this.height);\n    super.width = value;\n  }\n\n  get clientWidth() {\n    return super.width;\n  }\n\n  get clientHeight() {\n    return super.height;\n  }\n\n  // add and remove event listener\n  addEventListener(type, listener) {\n    return this._event.addListener(type, listener);\n  }\n\n  removeEventListener(type, listener) {\n    if (listener) return this._event.removeListener(type, listener);\n    return this._event.removeAllListeners(type);\n  }\n\n  _putImageData() {\n    let data;\n    const { width, height, _ctx, _gl, useTypedArray } = this;\n    const pixels = new Uint8Array(width * height * 4);\n    _gl.readPixels(0, 0, width, height, _gl.RGBA, _gl.UNSIGNED_BYTE, pixels);\n\n    if (useTypedArray) {\n      data = createImageData(new Uint8ClampedArray(pixels), width, height);\n    } else {\n      data = _ctx.getImageData(0, 0, width, height);\n      this._fillImageData(data, pixels, width, height);\n    }\n\n    _ctx.putImageData(data, 0, 0);\n  }\n\n  _fillImageData(data, pixels, width, height) {\n    for (let i = 0; i < height; i++) {\n      for (let j = 0; j < width; j++) {\n        const col = j;\n        const row = height - i - 1;\n        for (let k = 0; k < 4; k++) {\n          const idx = 4 * (row * width + col) + k;\n          const idx2 = 4 * (i * width + col) + k;\n          data.data[idx] = pixels[idx2];\n        }\n      }\n    }\n\n    return data;\n  }\n\n  // Store buffer png jpg and other data\n  toBuffer(...args) {\n    if (this._gl) this._putImageData();\n    return super.toBuffer(...args);\n  }\n\n  toDataURL(...args) {\n    if (this._gl) this._putImageData();\n    return super.toDataURL(...args);\n  }\n\n  createPNGStream(...args) {\n    if (this._gl) this._putImageData();\n    return super.createPNGStream(...args);\n  }\n\n  createJPEGStream(...args) {\n    if (this._gl) this._putImageData();\n    return super.createJPEGStream(...args);\n  }\n\n  createPDFStream(...args) {\n    if (this._gl) this._putImageData();\n    return super.createPDFStream(...args);\n  }\n\n  destroy() {\n    //super.destroy();\n    this._event.removeAllListeners();\n    this._event = null;\n    this._glResizeExt = null;\n    this._gl = null;\n  }\n}\n"],"mappings":"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"}