{"version":3,"file":"CanvasRenderer.js","names":["CanvasRenderer","SystemRenderer","constructor","options","arg2","arg3","type","RENDERER_TYPE","CANVAS","rootContext","view","getContext","alpha","transparent","context","refresh","maskManager","CanvasMaskManager","smoothProperty","imageSmoothingEnabled","webkitImageSmoothingEnabled","mozImageSmoothingEnabled","oImageSmoothingEnabled","msImageSmoothingEnabled","initPlugins","blendModes","mapCanvasBlendModesToPixi","_activeBlendMode","renderingToScreen","width","height","quality","anti","resize","antialias","render","displayObject","renderTexture","clear","transform","skipUpdateTransform","emit","rootResolution","resolution","_lastObjectRendered","cacheParent","parent","tempWt","_tempDisplayObjectParent","worldTransform","copy","_worldID","identity","updateTransform","save","setTransform","globalAlpha","BLEND_MODES","NORMAL","globalCompositeOperation","undefined","clearBeforeRender","clearRect","fillStyle","_backgroundColorString","fillRect","tempContext","renderCanvas","restore","clearColor","setBlendMode","blendMode","destroy","removeView","destroyPlugins","screenWidth","screenHeight","settings","SCALE_MODE","SCALE_MODES","LINEAR","invalidateBlendMode","indexOf","pluginTarget","mixin"],"sources":["../../../src/renderers/canvas/CanvasRenderer.js"],"sourcesContent":["import SystemRenderer from \"../SystemRenderer\";\nimport CanvasMaskManager from \"./utils/CanvasMaskManager\";\nimport mapCanvasBlendModesToPixi from \"./utils/mapCanvasBlendModesToPixi\";\nimport { pluginTarget } from \"../../utils\";\nimport { RENDERER_TYPE, SCALE_MODES, BLEND_MODES } from \"../../const\";\nimport settings from \"../../settings\";\n\nexport default class CanvasRenderer extends SystemRenderer {\n  constructor(options, arg2, arg3) {\n    super(\"Canvas\", options, arg2, arg3);\n\n    this.type = RENDERER_TYPE.CANVAS;\n    this.rootContext = this.view.getContext(\"2d\", {\n      alpha: this.transparent\n    });\n    this.context = this.rootContext;\n    this.refresh = true;\n    this.maskManager = new CanvasMaskManager(this);\n    this.smoothProperty = \"imageSmoothingEnabled\";\n\n    if (!this.rootContext.imageSmoothingEnabled) {\n      if (this.rootContext.webkitImageSmoothingEnabled) {\n        this.smoothProperty = \"webkitImageSmoothingEnabled\";\n      } else if (this.rootContext.mozImageSmoothingEnabled) {\n        this.smoothProperty = \"mozImageSmoothingEnabled\";\n      } else if (this.rootContext.oImageSmoothingEnabled) {\n        this.smoothProperty = \"oImageSmoothingEnabled\";\n      } else if (this.rootContext.msImageSmoothingEnabled) {\n        this.smoothProperty = \"msImageSmoothingEnabled\";\n      }\n    }\n\n    this.initPlugins();\n    this.blendModes = mapCanvasBlendModesToPixi();\n    this._activeBlendMode = null;\n    this.renderingToScreen = false;\n\n    const { width, height, quality, anti } = this.options;\n    this.resize(width, height);\n\n    if (quality) {\n      this.context.quality = quality;\n    }\n\n    if (anti) {\n      this.context.antialias = anti;\n    }\n  }\n\n  render(displayObject, renderTexture, clear, transform, skipUpdateTransform) {\n    if (!this.view) return;\n\n    this.renderingToScreen = !renderTexture;\n    this.emit(\"prerender\");\n    const rootResolution = this.resolution;\n\n    this.context = this.rootContext;\n    const context = this.context;\n\n    if (!renderTexture) {\n      this._lastObjectRendered = displayObject;\n    }\n\n    if (!skipUpdateTransform) {\n      const cacheParent = displayObject.parent;\n      const tempWt = this._tempDisplayObjectParent.transform.worldTransform;\n\n      if (transform) {\n        transform.copy(tempWt);\n        this._tempDisplayObjectParent.transform._worldID = -1;\n      } else {\n        tempWt.identity();\n      }\n\n      displayObject.parent = this._tempDisplayObjectParent;\n      displayObject.updateTransform();\n      displayObject.parent = cacheParent;\n    }\n\n    context.save();\n    context.setTransform(1, 0, 0, 1, 0, 0);\n    context.globalAlpha = 1;\n    this._activeBlendMode = BLEND_MODES.NORMAL;\n    context.globalCompositeOperation = this.blendModes[BLEND_MODES.NORMAL];\n\n    if (clear !== undefined ? clear : this.clearBeforeRender) {\n      if (this.renderingToScreen) {\n        if (this.transparent) {\n          context.clearRect(0, 0, this.width, this.height);\n        } else {\n          context.fillStyle = this._backgroundColorString;\n          context.fillRect(0, 0, this.width, this.height);\n        }\n      }\n    }\n\n    // TODO RENDER TARGET STUFF HERE..\n    const tempContext = this.context;\n    this.context = context;\n    displayObject.renderCanvas(this);\n    this.context = tempContext;\n\n    context.restore();\n    this.resolution = rootResolution;\n    this.emit(\"postrender\");\n  }\n\n  clear(clearColor) {\n    const context = this.context;\n\n    clearColor = clearColor || this._backgroundColorString;\n\n    if (!this.transparent && clearColor) {\n      context.fillStyle = clearColor;\n      context.fillRect(0, 0, this.width, this.height);\n    } else {\n      context.clearRect(0, 0, this.width, this.height);\n    }\n  }\n\n  setBlendMode(blendMode) {\n    if (this._activeBlendMode === blendMode) {\n      return;\n    }\n\n    this._activeBlendMode = blendMode;\n    this.context.globalCompositeOperation = this.blendModes[blendMode];\n  }\n\n  destroy(removeView) {\n    this.destroyPlugins();\n    super.destroy(removeView);\n\n    this.context = null;\n    this.refresh = true;\n    this.maskManager.destroy();\n    this.maskManager = null;\n    this.smoothProperty = null;\n  }\n\n  resize(screenWidth, screenHeight) {\n    super.resize(screenWidth, screenHeight);\n    if (this.smoothProperty) {\n      this.rootContext[this.smoothProperty] =\n        settings.SCALE_MODE === SCALE_MODES.LINEAR;\n    }\n  }\n\n  invalidateBlendMode() {\n    this._activeBlendMode = this.blendModes.indexOf(\n      this.context.globalCompositeOperation\n    );\n  }\n}\n\npluginTarget.mixin(CanvasRenderer);\n"],"mappings":"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"}