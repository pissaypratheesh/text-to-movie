{"version":3,"file":"TextureManager.js","names":["TextureManager","constructor","renderer","gl","_managedTextures","bindTexture","getTexture","updateTexture","texture","location","isRenderTexture","_glRenderTargets","hasLoaded","boundTextures","undefined","i","length","activeTexture","TEXTURE0","glTexture","_glTextures","CONTEXT_UID","renderTarget","RenderTarget","width","height","scaleMode","resolution","resize","_activeRenderTarget","root","frameBuffer","bind","GLTexture","premultiplyAlpha","upload","source","on","destroyTexture","push","isPowerOfTwo","mipmap","enableMipmap","wrapMode","WRAP_MODES","CLAMP","enableWrapClamp","REPEAT","enableWrapRepeat","enableWrapMirrorRepeat","SCALE_MODES","NEAREST","enableNearestScaling","enableLinearScaling","skipRemove","baseTexture","uid","glTextures","glRenderTargets","unbindTexture","destroy","off","indexOf","removeItems","bindRenderTarget","rootRenderTarget","removeAll"],"sources":["../../../src/renderers/webgl/TextureManager.js"],"sourcesContent":["import { GLTexture } from \"pixi-gl-core\";\nimport { WRAP_MODES, SCALE_MODES } from \"../../const\";\nimport RenderTarget from \"./utils/RenderTarget\";\nimport { removeItems } from \"../../utils\";\n\nexport default class TextureManager {\n  constructor(renderer) {\n    this.renderer = renderer;\n    this.gl = renderer.gl;\n    this._managedTextures = [];\n  }\n\n  bindTexture() {\n    // empty\n  }\n\n  getTexture() {\n    // empty\n  }\n\n  updateTexture(texture, location) {\n    const gl = this.gl;\n    const isRenderTexture = !!texture._glRenderTargets;\n\n    if (!texture.hasLoaded) {\n      return null;\n    }\n\n    const boundTextures = this.renderer.boundTextures;\n    if (location === undefined) {\n      location = 0;\n      for (let i = 0; i < boundTextures.length; ++i) {\n        if (boundTextures[i] === texture) {\n          location = i;\n          break;\n        }\n      }\n    }\n\n    boundTextures[location] = texture;\n    gl.activeTexture(gl.TEXTURE0 + location);\n    let glTexture = texture._glTextures[this.renderer.CONTEXT_UID];\n\n    if (!glTexture) {\n      if (isRenderTexture) {\n        const renderTarget = new RenderTarget(\n          this.gl,\n          texture.width,\n          texture.height,\n          texture.scaleMode,\n          texture.resolution\n        );\n\n        renderTarget.resize(texture.width, texture.height);\n        texture._glRenderTargets[this.renderer.CONTEXT_UID] = renderTarget;\n        glTexture = renderTarget.texture;\n\n        // framebuffer constructor disactivates current framebuffer\n        if (!this.renderer._activeRenderTarget.root) {\n          this.renderer._activeRenderTarget.frameBuffer.bind();\n        }\n      } else {\n        glTexture = new GLTexture(this.gl, null, null, null, null);\n        glTexture.bind(location);\n        glTexture.premultiplyAlpha = true;\n        glTexture.upload(texture.source);\n      }\n\n      texture._glTextures[this.renderer.CONTEXT_UID] = glTexture;\n      texture.on(\"update\", this.updateTexture, this);\n      texture.on(\"dispose\", this.destroyTexture, this);\n      this._managedTextures.push(texture);\n\n      if (texture.isPowerOfTwo) {\n        if (texture.mipmap) {\n          glTexture.enableMipmap();\n        }\n\n        if (texture.wrapMode === WRAP_MODES.CLAMP) {\n          glTexture.enableWrapClamp();\n        } else if (texture.wrapMode === WRAP_MODES.REPEAT) {\n          glTexture.enableWrapRepeat();\n        } else {\n          glTexture.enableWrapMirrorRepeat();\n        }\n      } else {\n        glTexture.enableWrapClamp();\n      }\n\n      if (texture.scaleMode === SCALE_MODES.NEAREST) {\n        glTexture.enableNearestScaling();\n      } else {\n        glTexture.enableLinearScaling();\n      }\n    }\n    // the texture already exists so we only need to update it..\n    else if (isRenderTexture) {\n      texture._glRenderTargets[this.renderer.CONTEXT_UID].resize(\n        texture.width,\n        texture.height\n      );\n    } else {\n      glTexture.upload(texture.source);\n    }\n\n    return glTexture;\n  }\n\n  destroyTexture(texture, skipRemove) {\n    texture = texture.baseTexture || texture;\n\n    if (!texture.hasLoaded) {\n      return;\n    }\n\n    const renderer = this.renderer;\n    const uid = renderer.CONTEXT_UID;\n    const glTextures = texture._glTextures;\n    const glRenderTargets = texture._glRenderTargets;\n\n    if (glTextures[uid]) {\n      renderer.unbindTexture(texture);\n\n      glTextures[uid].destroy();\n      texture.off(\"update\", this.updateTexture, this);\n      texture.off(\"dispose\", this.destroyTexture, this);\n\n      delete glTextures[uid];\n\n      if (!skipRemove) {\n        const i = this._managedTextures.indexOf(texture);\n\n        if (i !== -1) {\n          removeItems(this._managedTextures, i, 1);\n        }\n      }\n    }\n\n    if (glRenderTargets && glRenderTargets[uid]) {\n      if (renderer._activeRenderTarget === glRenderTargets[uid]) {\n        renderer.bindRenderTarget(renderer.rootRenderTarget);\n      }\n\n      glRenderTargets[uid].destroy();\n      delete glRenderTargets[uid];\n    }\n  }\n\n  /**\n   * Deletes all the textures from WebGL\n   */\n  removeAll() {\n    // empty all the old gl textures as they are useless now\n    for (let i = 0; i < this._managedTextures.length; ++i) {\n      const texture = this._managedTextures[i];\n\n      if (texture._glTextures[this.renderer.CONTEXT_UID]) {\n        delete texture._glTextures[this.renderer.CONTEXT_UID];\n      }\n    }\n  }\n\n  /**\n   * Destroys this manager and removes all its textures\n   */\n  destroy() {\n    // destroy managed textures\n    for (let i = 0; i < this._managedTextures.length; ++i) {\n      const texture = this._managedTextures[i];\n\n      this.destroyTexture(texture, true);\n\n      texture.off(\"update\", this.updateTexture, this);\n      texture.off(\"dispose\", this.destroyTexture, this);\n    }\n\n    this._managedTextures = null;\n  }\n}\n"],"mappings":"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"}