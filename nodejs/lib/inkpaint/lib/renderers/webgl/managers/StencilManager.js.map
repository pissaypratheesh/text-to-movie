{"version":3,"file":"StencilManager.js","names":["StencilManager","WebGLManager","constructor","renderer","stencilMaskStack","setMaskStack","gl","length","disable","STENCIL_TEST","enable","pushStencil","graphics","setObjectRenderer","plugins","_activeRenderTarget","attachStencilBuffer","prevMaskCount","push","colorMask","stencilFunc","EQUAL","_getBitwiseMask","stencilOp","KEEP","INCR","render","_useCurrent","popStencil","pop","clear","STENCIL_BUFFER_BIT","clearStencil","DECR","destroy","prototype","call","stencilStack"],"sources":["../../../../src/renderers/webgl/managers/StencilManager.js"],"sourcesContent":["import WebGLManager from \"./WebGLManager\";\n\nexport default class StencilManager extends WebGLManager {\n  constructor(renderer) {\n    super(renderer);\n    this.stencilMaskStack = null;\n  }\n\n  setMaskStack(stencilMaskStack) {\n    this.stencilMaskStack = stencilMaskStack;\n\n    const gl = this.renderer.gl;\n\n    if (stencilMaskStack.length === 0) {\n      gl.disable(gl.STENCIL_TEST);\n    } else {\n      gl.enable(gl.STENCIL_TEST);\n    }\n  }\n\n  pushStencil(graphics) {\n    this.renderer.setObjectRenderer(this.renderer.plugins.graphics);\n\n    this.renderer._activeRenderTarget.attachStencilBuffer();\n\n    const gl = this.renderer.gl;\n    const prevMaskCount = this.stencilMaskStack.length;\n\n    if (prevMaskCount === 0) {\n      gl.enable(gl.STENCIL_TEST);\n    }\n\n    this.stencilMaskStack.push(graphics);\n\n    // Increment the reference stencil value where the new mask overlaps with the old ones.\n    gl.colorMask(false, false, false, false);\n    gl.stencilFunc(gl.EQUAL, prevMaskCount, this._getBitwiseMask());\n    gl.stencilOp(gl.KEEP, gl.KEEP, gl.INCR);\n    this.renderer.plugins.graphics.render(graphics);\n\n    this._useCurrent();\n  }\n\n  popStencil() {\n    this.renderer.setObjectRenderer(this.renderer.plugins.graphics);\n\n    const gl = this.renderer.gl;\n    const graphics = this.stencilMaskStack.pop();\n\n    if (this.stencilMaskStack.length === 0) {\n      // the stack is empty!\n      gl.disable(gl.STENCIL_TEST);\n      gl.clear(gl.STENCIL_BUFFER_BIT);\n      gl.clearStencil(0);\n    } else {\n      // Decrement the reference stencil value where the popped mask overlaps with the other ones\n      gl.colorMask(false, false, false, false);\n      gl.stencilOp(gl.KEEP, gl.KEEP, gl.DECR);\n      this.renderer.plugins.graphics.render(graphics);\n\n      this._useCurrent();\n    }\n  }\n\n  _useCurrent() {\n    const gl = this.renderer.gl;\n\n    gl.colorMask(true, true, true, true);\n    gl.stencilFunc(\n      gl.EQUAL,\n      this.stencilMaskStack.length,\n      this._getBitwiseMask()\n    );\n    gl.stencilOp(gl.KEEP, gl.KEEP, gl.KEEP);\n  }\n\n  _getBitwiseMask() {\n    return (1 << this.stencilMaskStack.length) - 1;\n  }\n\n  destroy() {\n    WebGLManager.prototype.destroy.call(this);\n    this.stencilMaskStack.stencilStack = null;\n  }\n}\n"],"mappings":"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"}