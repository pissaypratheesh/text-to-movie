{"version":3,"file":"CanvasSpriteRenderer.js","names":["canvasRenderWorldTransform","Matrix","CanvasSpriteRenderer","constructor","renderer","render","sprite","texture","_texture","width","_frame","height","wt","transform","worldTransform","dx","dy","orig","baseTexture","source","setBlendMode","blendMode","valid","context","globalAlpha","worldAlpha","smoothingEnabled","scaleMode","SCALE_MODES","LINEAR","smoothProperty","anchor","x","y","rotate","copy","GroupD8","matrixAppendRotationInv","roundPixels","setTransform","a","b","c","d","tx","resolution","ty","adaptedNodeCanvas","sx","sy","dw","dh","trim","drawImage","isPSCanvas","isImageData","PsImage","convertToCanvas","data","length","destroy","CanvasRenderer","registerPlugin"],"sources":["../../../src/sprites/canvas/CanvasSpriteRenderer.js"],"sourcesContent":["import CanvasRenderer from \"../../renderers/canvas/CanvasRenderer\";\nimport { SCALE_MODES } from \"../../const\";\nimport { Matrix, GroupD8 } from \"../../math\";\nimport PsImage from \"../../polyfill/Image\";\nimport CanvasTinter from \"./CanvasTinter\";\n\nconst canvasRenderWorldTransform = new Matrix();\n\nexport default class CanvasSpriteRenderer {\n  constructor(renderer) {\n    this.renderer = renderer;\n  }\n\n  render(sprite) {\n    const texture = sprite._texture;\n    const renderer = this.renderer;\n\n    const width = texture._frame.width;\n    const height = texture._frame.height;\n\n    let wt = sprite.transform.worldTransform;\n    let dx = 0;\n    let dy = 0;\n\n    if (\n      texture.orig.width <= 0 ||\n      texture.orig.height <= 0 ||\n      !texture.baseTexture.source\n    ) {\n      return;\n    }\n\n    renderer.setBlendMode(sprite.blendMode);\n\n    //  Ignore null sources\n    if (texture.valid) {\n      renderer.context.globalAlpha = sprite.worldAlpha;\n\n      const smoothingEnabled =\n        texture.baseTexture.scaleMode === SCALE_MODES.LINEAR;\n\n      if (\n        renderer.smoothProperty &&\n        renderer.context[renderer.smoothProperty] !== smoothingEnabled\n      ) {\n        renderer.context[renderer.smoothProperty] = smoothingEnabled;\n      }\n\n      // if (texture.trim) {\n      //   dx =\n      //     texture.trim.width / 2 +\n      //     texture.trim.x -\n      //     sprite.anchor.x * texture.orig.width;\n      //   dy =\n      //     texture.trim.height / 2 +\n      //     texture.trim.y -\n      //     sprite.anchor.y * texture.orig.height;\n      // } else {\n      //   dx = (0.5 - sprite.anchor.x) * texture.orig.width;\n      //   dy = (0.5 - sprite.anchor.y) * texture.orig.height;\n      // }\n\n      dx = (0.5 - sprite.anchor.x) * texture.orig.width;\n      dy = (0.5 - sprite.anchor.y) * texture.orig.height;\n\n      if (texture.rotate) {\n        wt.copy(canvasRenderWorldTransform);\n        wt = canvasRenderWorldTransform;\n        GroupD8.matrixAppendRotationInv(wt, texture.rotate, dx, dy);\n        // the anchor has already been applied above, so lets set it to zero\n        dx = 0;\n        dy = 0;\n      }\n\n      dx -= width / 2;\n      dy -= height / 2;\n\n      // Allow for pixel rounding\n      if (renderer.roundPixels) {\n        renderer.context.setTransform(\n          wt.a,\n          wt.b,\n          wt.c,\n          wt.d,\n          (wt.tx * renderer.resolution) | 0,\n          (wt.ty * renderer.resolution) | 0\n        );\n\n        dx = dx | 0;\n        dy = dy | 0;\n      } else {\n        renderer.context.setTransform(\n          wt.a,\n          wt.b,\n          wt.c,\n          wt.d,\n          wt.tx * renderer.resolution,\n          wt.ty * renderer.resolution\n        );\n      }\n\n      const resolution = texture.baseTexture.resolution;\n\n      this.adaptedNodeCanvas(texture.baseTexture);\n\n      let sx, sy, dw, dh;\n      sx = texture._frame.x;\n      sy = texture._frame.y;\n\n      if (texture.trim) {\n        dw = texture.trim.width;\n        dh = texture.trim.height;\n      } else {\n        dw = width;\n        dh = height;\n      }\n\n      renderer.context.drawImage(\n        texture.baseTexture.source,\n        sx * resolution,\n        sy * resolution,\n        width * resolution,\n        height * resolution,\n        dx * renderer.resolution,\n        dy * renderer.resolution,\n        dw * renderer.resolution,\n        dh * renderer.resolution\n      );\n      // 0 0 100 100 -50 -50 100 100\n    }\n  }\n\n  adaptedNodeCanvas(baseTexture) {\n    if (!baseTexture.source) return;\n    if (baseTexture.source.isPSCanvas) return;\n\n    if (this.isImageData(baseTexture.source)) {\n      const { source, width, height } = baseTexture;\n      baseTexture.source = PsImage.convertToCanvas(source, width, height);\n    }\n  }\n\n  isImageData(data) {\n    if (!data) return false;\n    if (data.width && data.height && data.data && data.data.length) return true;\n    return false;\n  }\n\n  destroy() {\n    this.renderer = null;\n  }\n}\n\nCanvasRenderer.registerPlugin(\"sprite\", CanvasSpriteRenderer);\n"],"mappings":"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"}