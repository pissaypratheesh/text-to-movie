{"version":3,"file":"Ticker.js","names":["Ticker","constructor","_head","TickerListener","Infinity","_requestId","_maxElapsedMS","autoStart","deltaTime","elapsedMS","settings","TARGET_FPMS","lastTime","speed","started","_tick","bind","time","update","next","requestAnimationFrame","_requestIfNeeded","performance","now","_cancelIfNeeded","cancelAnimationFrame","_startIfPossible","start","add","fn","context","priority","UPDATE_PRIORITY","NORMAL","_addListener","addOnce","listener","current","previous","connect","remove","match","destroy","stop","currentTime","head","emit","FPS","minFPS","fps","minFPMS","Math","min","max"],"sources":["../../src/ticker/Ticker.js"],"sourcesContent":["import settings from \"../settings\";\nimport { UPDATE_PRIORITY } from \"../const\";\nimport TickerListener from \"./TickerListener\";\n\nexport default class Ticker {\n  constructor() {\n    this._head = new TickerListener(null, null, Infinity);\n    this._requestId = null;\n    this._maxElapsedMS = 100;\n\n    this.autoStart = false;\n    this.deltaTime = 1;\n    this.elapsedMS = 1 / settings.TARGET_FPMS;\n    this.lastTime = -1;\n    this.speed = 1;\n    this.started = false;\n    this._tick = this._tick.bind(this);\n  }\n\n  _tick(time) {\n    this._requestId = null;\n    if (!this.started) return;\n\n    this.update(time);\n    if (this.started && this._requestId === null && this._head.next) {\n      this._requestId = requestAnimationFrame(this._tick);\n    }\n  }\n\n  _requestIfNeeded() {\n    if (this._requestId === null && this._head.next) {\n      this.lastTime = performance.now();\n      this._requestId = requestAnimationFrame(this._tick);\n    }\n  }\n\n  _cancelIfNeeded() {\n    if (this._requestId !== null) {\n      cancelAnimationFrame(this._requestId);\n      this._requestId = null;\n    }\n  }\n\n  _startIfPossible() {\n    if (this.started) {\n      this._requestIfNeeded();\n    } else if (this.autoStart) {\n      this.start();\n    }\n  }\n\n  add(fn, context, priority = UPDATE_PRIORITY.NORMAL) {\n    return this._addListener(new TickerListener(fn, context, priority));\n  }\n\n  addOnce(fn, context, priority = UPDATE_PRIORITY.NORMAL) {\n    return this._addListener(new TickerListener(fn, context, priority, true));\n  }\n\n  _addListener(listener) {\n    let current = this._head.next;\n    let previous = this._head;\n\n    if (!current) {\n      listener.connect(previous);\n    } else {\n      while (current) {\n        if (listener.priority > current.priority) {\n          listener.connect(previous);\n          break;\n        }\n        previous = current;\n        current = current.next;\n      }\n\n      if (!listener.previous) {\n        listener.connect(previous);\n      }\n    }\n\n    this._startIfPossible();\n    return this;\n  }\n\n  remove(fn, context) {\n    let listener = this._head.next;\n\n    while (listener) {\n      if (listener.match(fn, context)) {\n        listener = listener.destroy();\n      } else {\n        listener = listener.next;\n      }\n    }\n\n    if (!this._head.next) {\n      this._cancelIfNeeded();\n    }\n\n    return this;\n  }\n\n  start() {\n    if (!this.started) {\n      this.started = true;\n      this._requestIfNeeded();\n    }\n  }\n\n  stop() {\n    if (this.started) {\n      this.started = false;\n      this._cancelIfNeeded();\n    }\n  }\n\n  destroy() {\n    this.stop();\n    let listener = this._head.next;\n    while (listener) {\n      listener = listener.destroy(true);\n    }\n\n    this._head.destroy();\n    this._head = null;\n  }\n\n  update(currentTime = performance.now()) {\n    let elapsedMS;\n\n    if (currentTime > this.lastTime) {\n      elapsedMS = this.elapsedMS = currentTime - this.lastTime;\n      if (elapsedMS > this._maxElapsedMS) {\n        elapsedMS = this._maxElapsedMS;\n      }\n\n      this.deltaTime = elapsedMS * settings.TARGET_FPMS * this.speed;\n      const head = this._head;\n      let listener = head.next;\n\n      while (listener) {\n        listener = listener.emit(this.deltaTime);\n      }\n\n      if (!head.next) {\n        this._cancelIfNeeded();\n      }\n    } else {\n      this.deltaTime = this.elapsedMS = 0;\n    }\n\n    this.lastTime = currentTime;\n  }\n\n  get FPS() {\n    return 1000 / this.elapsedMS;\n  }\n\n  get minFPS() {\n    return 1000 / this._maxElapsedMS;\n  }\n\n  set minFPS(fps) {\n    const minFPMS = Math.min(Math.max(0, fps) / 1000, settings.TARGET_FPMS);\n    this._maxElapsedMS = 1 / minFPMS;\n  }\n}\n"],"mappings":";;;;;;AAAA;AACA;AACA;AAA8C;AAE/B,MAAMA,MAAM,CAAC;EAC1BC,WAAW,GAAG;IACZ,IAAI,CAACC,KAAK,GAAG,IAAIC,uBAAc,CAAC,IAAI,EAAE,IAAI,EAAEC,QAAQ,CAAC;IACrD,IAAI,CAACC,UAAU,GAAG,IAAI;IACtB,IAAI,CAACC,aAAa,GAAG,GAAG;IAExB,IAAI,CAACC,SAAS,GAAG,KAAK;IACtB,IAAI,CAACC,SAAS,GAAG,CAAC;IAClB,IAAI,CAACC,SAAS,GAAG,CAAC,GAAGC,iBAAQ,CAACC,WAAW;IACzC,IAAI,CAACC,QAAQ,GAAG,CAAC,CAAC;IAClB,IAAI,CAACC,KAAK,GAAG,CAAC;IACd,IAAI,CAACC,OAAO,GAAG,KAAK;IACpB,IAAI,CAACC,KAAK,GAAG,IAAI,CAACA,KAAK,CAACC,IAAI,CAAC,IAAI,CAAC;EACpC;EAEAD,KAAK,CAACE,IAAI,EAAE;IACV,IAAI,CAACZ,UAAU,GAAG,IAAI;IACtB,IAAI,CAAC,IAAI,CAACS,OAAO,EAAE;IAEnB,IAAI,CAACI,MAAM,CAACD,IAAI,CAAC;IACjB,IAAI,IAAI,CAACH,OAAO,IAAI,IAAI,CAACT,UAAU,KAAK,IAAI,IAAI,IAAI,CAACH,KAAK,CAACiB,IAAI,EAAE;MAC/D,IAAI,CAACd,UAAU,GAAGe,qBAAqB,CAAC,IAAI,CAACL,KAAK,CAAC;IACrD;EACF;EAEAM,gBAAgB,GAAG;IACjB,IAAI,IAAI,CAAChB,UAAU,KAAK,IAAI,IAAI,IAAI,CAACH,KAAK,CAACiB,IAAI,EAAE;MAC/C,IAAI,CAACP,QAAQ,GAAGU,WAAW,CAACC,GAAG,EAAE;MACjC,IAAI,CAAClB,UAAU,GAAGe,qBAAqB,CAAC,IAAI,CAACL,KAAK,CAAC;IACrD;EACF;EAEAS,eAAe,GAAG;IAChB,IAAI,IAAI,CAACnB,UAAU,KAAK,IAAI,EAAE;MAC5BoB,oBAAoB,CAAC,IAAI,CAACpB,UAAU,CAAC;MACrC,IAAI,CAACA,UAAU,GAAG,IAAI;IACxB;EACF;EAEAqB,gBAAgB,GAAG;IACjB,IAAI,IAAI,CAACZ,OAAO,EAAE;MAChB,IAAI,CAACO,gBAAgB,EAAE;IACzB,CAAC,MAAM,IAAI,IAAI,CAACd,SAAS,EAAE;MACzB,IAAI,CAACoB,KAAK,EAAE;IACd;EACF;EAEAC,GAAG,CAACC,EAAE,EAAEC,OAAO,EAAEC,QAAQ,EAA2B;IAAA,IAAnCA,QAAQ;MAARA,QAAQ,GAAGC,sBAAe,CAACC,MAAM;IAAA;IAChD,OAAO,IAAI,CAACC,YAAY,CAAC,IAAI/B,uBAAc,CAAC0B,EAAE,EAAEC,OAAO,EAAEC,QAAQ,CAAC,CAAC;EACrE;EAEAI,OAAO,CAACN,EAAE,EAAEC,OAAO,EAAEC,QAAQ,EAA2B;IAAA,IAAnCA,QAAQ;MAARA,QAAQ,GAAGC,sBAAe,CAACC,MAAM;IAAA;IACpD,OAAO,IAAI,CAACC,YAAY,CAAC,IAAI/B,uBAAc,CAAC0B,EAAE,EAAEC,OAAO,EAAEC,QAAQ,EAAE,IAAI,CAAC,CAAC;EAC3E;EAEAG,YAAY,CAACE,QAAQ,EAAE;IACrB,IAAIC,OAAO,GAAG,IAAI,CAACnC,KAAK,CAACiB,IAAI;IAC7B,IAAImB,QAAQ,GAAG,IAAI,CAACpC,KAAK;IAEzB,IAAI,CAACmC,OAAO,EAAE;MACZD,QAAQ,CAACG,OAAO,CAACD,QAAQ,CAAC;IAC5B,CAAC,MAAM;MACL,OAAOD,OAAO,EAAE;QACd,IAAID,QAAQ,CAACL,QAAQ,GAAGM,OAAO,CAACN,QAAQ,EAAE;UACxCK,QAAQ,CAACG,OAAO,CAACD,QAAQ,CAAC;UAC1B;QACF;QACAA,QAAQ,GAAGD,OAAO;QAClBA,OAAO,GAAGA,OAAO,CAAClB,IAAI;MACxB;MAEA,IAAI,CAACiB,QAAQ,CAACE,QAAQ,EAAE;QACtBF,QAAQ,CAACG,OAAO,CAACD,QAAQ,CAAC;MAC5B;IACF;IAEA,IAAI,CAACZ,gBAAgB,EAAE;IACvB,OAAO,IAAI;EACb;EAEAc,MAAM,CAACX,EAAE,EAAEC,OAAO,EAAE;IAClB,IAAIM,QAAQ,GAAG,IAAI,CAAClC,KAAK,CAACiB,IAAI;IAE9B,OAAOiB,QAAQ,EAAE;MACf,IAAIA,QAAQ,CAACK,KAAK,CAACZ,EAAE,EAAEC,OAAO,CAAC,EAAE;QAC/BM,QAAQ,GAAGA,QAAQ,CAACM,OAAO,EAAE;MAC/B,CAAC,MAAM;QACLN,QAAQ,GAAGA,QAAQ,CAACjB,IAAI;MAC1B;IACF;IAEA,IAAI,CAAC,IAAI,CAACjB,KAAK,CAACiB,IAAI,EAAE;MACpB,IAAI,CAACK,eAAe,EAAE;IACxB;IAEA,OAAO,IAAI;EACb;EAEAG,KAAK,GAAG;IACN,IAAI,CAAC,IAAI,CAACb,OAAO,EAAE;MACjB,IAAI,CAACA,OAAO,GAAG,IAAI;MACnB,IAAI,CAACO,gBAAgB,EAAE;IACzB;EACF;EAEAsB,IAAI,GAAG;IACL,IAAI,IAAI,CAAC7B,OAAO,EAAE;MAChB,IAAI,CAACA,OAAO,GAAG,KAAK;MACpB,IAAI,CAACU,eAAe,EAAE;IACxB;EACF;EAEAkB,OAAO,GAAG;IACR,IAAI,CAACC,IAAI,EAAE;IACX,IAAIP,QAAQ,GAAG,IAAI,CAAClC,KAAK,CAACiB,IAAI;IAC9B,OAAOiB,QAAQ,EAAE;MACfA,QAAQ,GAAGA,QAAQ,CAACM,OAAO,CAAC,IAAI,CAAC;IACnC;IAEA,IAAI,CAACxC,KAAK,CAACwC,OAAO,EAAE;IACpB,IAAI,CAACxC,KAAK,GAAG,IAAI;EACnB;EAEAgB,MAAM,CAAC0B,WAAW,EAAsB;IAAA,IAAjCA,WAAW;MAAXA,WAAW,GAAGtB,WAAW,CAACC,GAAG,EAAE;IAAA;IACpC,IAAId,SAAS;IAEb,IAAImC,WAAW,GAAG,IAAI,CAAChC,QAAQ,EAAE;MAC/BH,SAAS,GAAG,IAAI,CAACA,SAAS,GAAGmC,WAAW,GAAG,IAAI,CAAChC,QAAQ;MACxD,IAAIH,SAAS,GAAG,IAAI,CAACH,aAAa,EAAE;QAClCG,SAAS,GAAG,IAAI,CAACH,aAAa;MAChC;MAEA,IAAI,CAACE,SAAS,GAAGC,SAAS,GAAGC,iBAAQ,CAACC,WAAW,GAAG,IAAI,CAACE,KAAK;MAC9D,IAAMgC,IAAI,GAAG,IAAI,CAAC3C,KAAK;MACvB,IAAIkC,QAAQ,GAAGS,IAAI,CAAC1B,IAAI;MAExB,OAAOiB,QAAQ,EAAE;QACfA,QAAQ,GAAGA,QAAQ,CAACU,IAAI,CAAC,IAAI,CAACtC,SAAS,CAAC;MAC1C;MAEA,IAAI,CAACqC,IAAI,CAAC1B,IAAI,EAAE;QACd,IAAI,CAACK,eAAe,EAAE;MACxB;IACF,CAAC,MAAM;MACL,IAAI,CAAChB,SAAS,GAAG,IAAI,CAACC,SAAS,GAAG,CAAC;IACrC;IAEA,IAAI,CAACG,QAAQ,GAAGgC,WAAW;EAC7B;EAEA,IAAIG,GAAG,GAAG;IACR,OAAO,IAAI,GAAG,IAAI,CAACtC,SAAS;EAC9B;EAEA,IAAIuC,MAAM,GAAG;IACX,OAAO,IAAI,GAAG,IAAI,CAAC1C,aAAa;EAClC;EAEA,IAAI0C,MAAM,CAACC,GAAG,EAAE;IACd,IAAMC,OAAO,GAAGC,IAAI,CAACC,GAAG,CAACD,IAAI,CAACE,GAAG,CAAC,CAAC,EAAEJ,GAAG,CAAC,GAAG,IAAI,EAAEvC,iBAAQ,CAACC,WAAW,CAAC;IACvE,IAAI,CAACL,aAAa,GAAG,CAAC,GAAG4C,OAAO;EAClC;AACF;AAAC"}