{"version":3,"file":"TextureMatrix.js","names":["tempMat","Matrix","TextureMatrix","constructor","texture","clampMargin","_texture","mapCoord","uClampFrame","Float32Array","uClampOffset","_lastTextureID","clampOffset","value","multiplyUvs","uvs","out","undefined","mat","i","length","x","y","a","c","tx","b","d","ty","update","forceUpdate","tex","valid","_updateID","_uvs","set","x1","x0","y1","y0","x3","y3","orig","trim","width","height","append","texBase","baseTexture","frame","margin","resolution","offset","_frame","realWidth","realHeight"],"sources":["../../src/textures/TextureMatrix.js"],"sourcesContent":["import { default as Matrix } from \"../math/Matrix\";\n\nconst tempMat = new Matrix();\n\nexport default class TextureMatrix {\n  constructor(texture, clampMargin) {\n    this._texture = texture;\n    this.mapCoord = new Matrix();\n    this.uClampFrame = new Float32Array(4);\n    this.uClampOffset = new Float32Array(2);\n    this._lastTextureID = -1;\n    this.clampOffset = 0;\n    this.clampMargin = typeof clampMargin === \"undefined\" ? 0.5 : clampMargin;\n  }\n\n  get texture() {\n    return this._texture;\n  }\n\n  set texture(value) {\n    this._texture = value;\n    this._lastTextureID = -1;\n  }\n\n  multiplyUvs(uvs, out) {\n    if (out === undefined) {\n      out = uvs;\n    }\n\n    const mat = this.mapCoord;\n\n    for (let i = 0; i < uvs.length; i += 2) {\n      const x = uvs[i];\n      const y = uvs[i + 1];\n\n      out[i] = x * mat.a + y * mat.c + mat.tx;\n      out[i + 1] = x * mat.b + y * mat.d + mat.ty;\n    }\n\n    return out;\n  }\n\n  update(forceUpdate) {\n    const tex = this._texture;\n\n    if (!tex || !tex.valid) {\n      return false;\n    }\n\n    if (!forceUpdate && this._lastTextureID === tex._updateID) {\n      return false;\n    }\n\n    this._lastTextureID = tex._updateID;\n\n    const uvs = tex._uvs;\n\n    this.mapCoord.set(\n      uvs.x1 - uvs.x0,\n      uvs.y1 - uvs.y0,\n      uvs.x3 - uvs.x0,\n      uvs.y3 - uvs.y0,\n      uvs.x0,\n      uvs.y0\n    );\n\n    const orig = tex.orig;\n    const trim = tex.trim;\n\n    if (trim) {\n      tempMat.set(\n        orig.width / trim.width,\n        0,\n        0,\n        orig.height / trim.height,\n        -trim.x / trim.width,\n        -trim.y / trim.height\n      );\n      this.mapCoord.append(tempMat);\n    }\n\n    const texBase = tex.baseTexture;\n    const frame = this.uClampFrame;\n    const margin = this.clampMargin / texBase.resolution;\n    const offset = this.clampOffset;\n\n    frame[0] = (tex._frame.x + margin + offset) / texBase.width;\n    frame[1] = (tex._frame.y + margin + offset) / texBase.height;\n    frame[2] =\n      (tex._frame.x + tex._frame.width - margin + offset) / texBase.width;\n    frame[3] =\n      (tex._frame.y + tex._frame.height - margin + offset) / texBase.height;\n    this.uClampOffset[0] = offset / texBase.realWidth;\n    this.uClampOffset[1] = offset / texBase.realHeight;\n\n    return true;\n  }\n}\n"],"mappings":"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"}