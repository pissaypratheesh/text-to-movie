{"version":3,"file":"GraphicsRenderer.js","names":["GraphicsRenderer","ObjectRenderer","constructor","renderer","graphicsDataPool","primitiveShader","gl","CONTEXT_UID","onContextChange","PrimitiveShader","destroy","prototype","call","i","length","render","graphics","webGLData","webGL","_webGL","dirty","updateGraphics","shader","bindShader","state","setBlendMode","blendMode","n","data","shaderTemp","uniforms","translationMatrix","transform","worldTransform","toArray","tint","hex2rgb","alpha","worldAlpha","bindVao","vao","nativeLines","drawArrays","LINES","points","draw","TRIANGLE_STRIP","indices","lastIndex","clearDirty","push","webGLDataNativeLines","graphicsData","getWebGLData","lineWidth","type","SHAPES","POLY","buildPoly","RECT","buildRectangle","CIRC","ELIP","buildCircle","RREC","buildRoundedRectangle","upload","pop","WebGLGraphicsData","attribsState","reset","WebGLRenderer","registerPlugin"],"sources":["../../../src/graphics/webgl/GraphicsRenderer.js"],"sourcesContent":["import { hex2rgb } from \"../../utils\";\nimport { SHAPES } from \"../../const\";\nimport ObjectRenderer from \"../../renderers/webgl/utils/ObjectRenderer\";\nimport WebGLRenderer from \"../../renderers/webgl/WebGLRenderer\";\nimport WebGLGraphicsData from \"./WebGLGraphicsData\";\nimport PrimitiveShader from \"./shaders/PrimitiveShader\";\n\nimport buildPoly from \"./utils/buildPoly\";\nimport buildRectangle from \"./utils/buildRectangle\";\nimport buildRoundedRectangle from \"./utils/buildRoundedRectangle\";\nimport buildCircle from \"./utils/buildCircle\";\n\n/**\n * Renders the graphics object.\n *\n * @class\n * @memberof InkPaint\n * @extends InkPaint.ObjectRenderer\n */\nexport default class GraphicsRenderer extends ObjectRenderer {\n  /**\n   * @param {InkPaint.WebGLRenderer} renderer - The renderer this object renderer works for.\n   */\n  constructor(renderer) {\n    super(renderer);\n\n    this.graphicsDataPool = [];\n\n    this.primitiveShader = null;\n\n    this.gl = renderer.gl;\n\n    // easy access!\n    this.CONTEXT_UID = 0;\n  }\n\n  /**\n   * Called when there is a WebGL context change\n   *\n   * @private\n   *\n   */\n  onContextChange() {\n    this.gl = this.renderer.gl;\n    this.CONTEXT_UID = this.renderer.CONTEXT_UID;\n    this.primitiveShader = new PrimitiveShader(this.gl);\n  }\n\n  /**\n   * Destroys this renderer.\n   *\n   */\n  destroy() {\n    ObjectRenderer.prototype.destroy.call(this);\n\n    for (let i = 0; i < this.graphicsDataPool.length; ++i) {\n      this.graphicsDataPool[i].destroy();\n    }\n\n    this.graphicsDataPool = null;\n  }\n\n  /**\n   * Renders a graphics object.\n   *\n   * @param {InkPaint.Graphics} graphics - The graphics object to render.\n   */\n  render(graphics) {\n    const renderer = this.renderer;\n    const gl = renderer.gl;\n\n    let webGLData;\n    let webGL = graphics._webGL[this.CONTEXT_UID];\n\n    if (!webGL || graphics.dirty !== webGL.dirty) {\n      this.updateGraphics(graphics);\n\n      webGL = graphics._webGL[this.CONTEXT_UID];\n    }\n\n    // This  could be speeded up for sure!\n    const shader = this.primitiveShader;\n\n    renderer.bindShader(shader);\n    renderer.state.setBlendMode(graphics.blendMode);\n\n    for (let i = 0, n = webGL.data.length; i < n; i++) {\n      webGLData = webGL.data[i];\n      const shaderTemp = webGLData.shader;\n\n      renderer.bindShader(shaderTemp);\n      shaderTemp.uniforms.translationMatrix = graphics.transform.worldTransform.toArray(\n        true\n      );\n      shaderTemp.uniforms.tint = hex2rgb(graphics.tint);\n      shaderTemp.uniforms.alpha = graphics.worldAlpha;\n\n      renderer.bindVao(webGLData.vao);\n\n      if (webGLData.nativeLines) {\n        gl.drawArrays(gl.LINES, 0, webGLData.points.length / 6);\n      } else {\n        webGLData.vao.draw(gl.TRIANGLE_STRIP, webGLData.indices.length);\n      }\n    }\n  }\n\n  /**\n   * Updates the graphics object\n   *\n   * @private\n   * @param {InkPaint.Graphics} graphics - The graphics object to update\n   */\n  updateGraphics(graphics) {\n    const gl = this.renderer.gl;\n\n    // get the contexts graphics object\n    let webGL = graphics._webGL[this.CONTEXT_UID];\n\n    // if the graphics object does not exist in the webGL context time to create it!\n    if (!webGL) {\n      webGL = graphics._webGL[this.CONTEXT_UID] = {\n        lastIndex: 0,\n        data: [],\n        gl,\n        clearDirty: -1,\n        dirty: -1\n      };\n    }\n\n    // flag the graphics as not dirty as we are about to update it...\n    webGL.dirty = graphics.dirty;\n\n    // if the user cleared the graphics object we will need to clear every object\n    if (graphics.clearDirty !== webGL.clearDirty) {\n      webGL.clearDirty = graphics.clearDirty;\n\n      // loop through and return all the webGLDatas to the object pool so than can be reused later on\n      for (let i = 0; i < webGL.data.length; i++) {\n        this.graphicsDataPool.push(webGL.data[i]);\n      }\n\n      // clear the array and reset the index..\n      webGL.data.length = 0;\n      webGL.lastIndex = 0;\n    }\n\n    let webGLData;\n    let webGLDataNativeLines;\n\n    // loop through the graphics datas and construct each one..\n    // if the object is a complex fill then the new stencil buffer technique will be used\n    // other wise graphics objects will be pushed into a batch..\n    for (let i = webGL.lastIndex; i < graphics.graphicsData.length; i++) {\n      const data = graphics.graphicsData[i];\n\n      // TODO - this can be simplified\n      webGLData = this.getWebGLData(webGL, 0);\n\n      if (data.nativeLines && data.lineWidth) {\n        webGLDataNativeLines = this.getWebGLData(webGL, 0, true);\n        webGL.lastIndex++;\n      }\n\n      if (data.type === SHAPES.POLY) {\n        buildPoly(data, webGLData, webGLDataNativeLines);\n      }\n      if (data.type === SHAPES.RECT) {\n        buildRectangle(data, webGLData, webGLDataNativeLines);\n      } else if (data.type === SHAPES.CIRC || data.type === SHAPES.ELIP) {\n        buildCircle(data, webGLData, webGLDataNativeLines);\n      } else if (data.type === SHAPES.RREC) {\n        buildRoundedRectangle(data, webGLData, webGLDataNativeLines);\n      }\n\n      webGL.lastIndex++;\n    }\n\n    this.renderer.bindVao(null);\n\n    // upload all the dirty data...\n    for (let i = 0; i < webGL.data.length; i++) {\n      webGLData = webGL.data[i];\n\n      if (webGLData.dirty) {\n        webGLData.upload();\n      }\n    }\n  }\n\n  /**\n   *\n   * @private\n   * @param {WebGLRenderingContext} gl - the current WebGL drawing context\n   * @param {number} type - TODO @Alvin\n   * @param {number} nativeLines - indicate whether the webGLData use for nativeLines.\n   * @return {*} TODO\n   */\n  getWebGLData(gl, type, nativeLines) {\n    let webGLData = gl.data[gl.data.length - 1];\n\n    if (\n      !webGLData ||\n      webGLData.nativeLines !== nativeLines ||\n      webGLData.points.length > 320000\n    ) {\n      webGLData =\n        this.graphicsDataPool.pop() ||\n        new WebGLGraphicsData(\n          this.renderer.gl,\n          this.primitiveShader,\n          this.renderer.state.attribsState\n        );\n      webGLData.nativeLines = nativeLines;\n      webGLData.reset(type);\n      gl.data.push(webGLData);\n    }\n\n    webGLData.dirty = true;\n\n    return webGLData;\n  }\n}\n\nWebGLRenderer.registerPlugin(\"graphics\", GraphicsRenderer);\n"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAA8C;AAE9C;AACA;AACA;AACA;AACA;AACA;AACA;AACe,MAAMA,gBAAgB,SAASC,uBAAc,CAAC;EAC3D;AACF;AACA;EACEC,WAAW,CAACC,QAAQ,EAAE;IACpB,KAAK,CAACA,QAAQ,CAAC;IAEf,IAAI,CAACC,gBAAgB,GAAG,EAAE;IAE1B,IAAI,CAACC,eAAe,GAAG,IAAI;IAE3B,IAAI,CAACC,EAAE,GAAGH,QAAQ,CAACG,EAAE;;IAErB;IACA,IAAI,CAACC,WAAW,GAAG,CAAC;EACtB;;EAEA;AACF;AACA;AACA;AACA;AACA;EACEC,eAAe,GAAG;IAChB,IAAI,CAACF,EAAE,GAAG,IAAI,CAACH,QAAQ,CAACG,EAAE;IAC1B,IAAI,CAACC,WAAW,GAAG,IAAI,CAACJ,QAAQ,CAACI,WAAW;IAC5C,IAAI,CAACF,eAAe,GAAG,IAAII,wBAAe,CAAC,IAAI,CAACH,EAAE,CAAC;EACrD;;EAEA;AACF;AACA;AACA;EACEI,OAAO,GAAG;IACRT,uBAAc,CAACU,SAAS,CAACD,OAAO,CAACE,IAAI,CAAC,IAAI,CAAC;IAE3C,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAG,IAAI,CAACT,gBAAgB,CAACU,MAAM,EAAE,EAAED,CAAC,EAAE;MACrD,IAAI,CAACT,gBAAgB,CAACS,CAAC,CAAC,CAACH,OAAO,EAAE;IACpC;IAEA,IAAI,CAACN,gBAAgB,GAAG,IAAI;EAC9B;;EAEA;AACF;AACA;AACA;AACA;EACEW,MAAM,CAACC,QAAQ,EAAE;IACf,IAAMb,QAAQ,GAAG,IAAI,CAACA,QAAQ;IAC9B,IAAMG,EAAE,GAAGH,QAAQ,CAACG,EAAE;IAEtB,IAAIW,SAAS;IACb,IAAIC,KAAK,GAAGF,QAAQ,CAACG,MAAM,CAAC,IAAI,CAACZ,WAAW,CAAC;IAE7C,IAAI,CAACW,KAAK,IAAIF,QAAQ,CAACI,KAAK,KAAKF,KAAK,CAACE,KAAK,EAAE;MAC5C,IAAI,CAACC,cAAc,CAACL,QAAQ,CAAC;MAE7BE,KAAK,GAAGF,QAAQ,CAACG,MAAM,CAAC,IAAI,CAACZ,WAAW,CAAC;IAC3C;;IAEA;IACA,IAAMe,MAAM,GAAG,IAAI,CAACjB,eAAe;IAEnCF,QAAQ,CAACoB,UAAU,CAACD,MAAM,CAAC;IAC3BnB,QAAQ,CAACqB,KAAK,CAACC,YAAY,CAACT,QAAQ,CAACU,SAAS,CAAC;IAE/C,KAAK,IAAIb,CAAC,GAAG,CAAC,EAAEc,CAAC,GAAGT,KAAK,CAACU,IAAI,CAACd,MAAM,EAAED,CAAC,GAAGc,CAAC,EAAEd,CAAC,EAAE,EAAE;MACjDI,SAAS,GAAGC,KAAK,CAACU,IAAI,CAACf,CAAC,CAAC;MACzB,IAAMgB,UAAU,GAAGZ,SAAS,CAACK,MAAM;MAEnCnB,QAAQ,CAACoB,UAAU,CAACM,UAAU,CAAC;MAC/BA,UAAU,CAACC,QAAQ,CAACC,iBAAiB,GAAGf,QAAQ,CAACgB,SAAS,CAACC,cAAc,CAACC,OAAO,CAC/E,IAAI,CACL;MACDL,UAAU,CAACC,QAAQ,CAACK,IAAI,GAAG,IAAAC,cAAO,EAACpB,QAAQ,CAACmB,IAAI,CAAC;MACjDN,UAAU,CAACC,QAAQ,CAACO,KAAK,GAAGrB,QAAQ,CAACsB,UAAU;MAE/CnC,QAAQ,CAACoC,OAAO,CAACtB,SAAS,CAACuB,GAAG,CAAC;MAE/B,IAAIvB,SAAS,CAACwB,WAAW,EAAE;QACzBnC,EAAE,CAACoC,UAAU,CAACpC,EAAE,CAACqC,KAAK,EAAE,CAAC,EAAE1B,SAAS,CAAC2B,MAAM,CAAC9B,MAAM,GAAG,CAAC,CAAC;MACzD,CAAC,MAAM;QACLG,SAAS,CAACuB,GAAG,CAACK,IAAI,CAACvC,EAAE,CAACwC,cAAc,EAAE7B,SAAS,CAAC8B,OAAO,CAACjC,MAAM,CAAC;MACjE;IACF;EACF;;EAEA;AACF;AACA;AACA;AACA;AACA;EACEO,cAAc,CAACL,QAAQ,EAAE;IACvB,IAAMV,EAAE,GAAG,IAAI,CAACH,QAAQ,CAACG,EAAE;;IAE3B;IACA,IAAIY,KAAK,GAAGF,QAAQ,CAACG,MAAM,CAAC,IAAI,CAACZ,WAAW,CAAC;;IAE7C;IACA,IAAI,CAACW,KAAK,EAAE;MACVA,KAAK,GAAGF,QAAQ,CAACG,MAAM,CAAC,IAAI,CAACZ,WAAW,CAAC,GAAG;QAC1CyC,SAAS,EAAE,CAAC;QACZpB,IAAI,EAAE,EAAE;QACRtB,EAAE;QACF2C,UAAU,EAAE,CAAC,CAAC;QACd7B,KAAK,EAAE,CAAC;MACV,CAAC;IACH;;IAEA;IACAF,KAAK,CAACE,KAAK,GAAGJ,QAAQ,CAACI,KAAK;;IAE5B;IACA,IAAIJ,QAAQ,CAACiC,UAAU,KAAK/B,KAAK,CAAC+B,UAAU,EAAE;MAC5C/B,KAAK,CAAC+B,UAAU,GAAGjC,QAAQ,CAACiC,UAAU;;MAEtC;MACA,KAAK,IAAIpC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGK,KAAK,CAACU,IAAI,CAACd,MAAM,EAAED,CAAC,EAAE,EAAE;QAC1C,IAAI,CAACT,gBAAgB,CAAC8C,IAAI,CAAChC,KAAK,CAACU,IAAI,CAACf,CAAC,CAAC,CAAC;MAC3C;;MAEA;MACAK,KAAK,CAACU,IAAI,CAACd,MAAM,GAAG,CAAC;MACrBI,KAAK,CAAC8B,SAAS,GAAG,CAAC;IACrB;IAEA,IAAI/B,SAAS;IACb,IAAIkC,oBAAoB;;IAExB;IACA;IACA;IACA,KAAK,IAAItC,EAAC,GAAGK,KAAK,CAAC8B,SAAS,EAAEnC,EAAC,GAAGG,QAAQ,CAACoC,YAAY,CAACtC,MAAM,EAAED,EAAC,EAAE,EAAE;MACnE,IAAMe,IAAI,GAAGZ,QAAQ,CAACoC,YAAY,CAACvC,EAAC,CAAC;;MAErC;MACAI,SAAS,GAAG,IAAI,CAACoC,YAAY,CAACnC,KAAK,EAAE,CAAC,CAAC;MAEvC,IAAIU,IAAI,CAACa,WAAW,IAAIb,IAAI,CAAC0B,SAAS,EAAE;QACtCH,oBAAoB,GAAG,IAAI,CAACE,YAAY,CAACnC,KAAK,EAAE,CAAC,EAAE,IAAI,CAAC;QACxDA,KAAK,CAAC8B,SAAS,EAAE;MACnB;MAEA,IAAIpB,IAAI,CAAC2B,IAAI,KAAKC,aAAM,CAACC,IAAI,EAAE;QAC7B,IAAAC,kBAAS,EAAC9B,IAAI,EAAEX,SAAS,EAAEkC,oBAAoB,CAAC;MAClD;MACA,IAAIvB,IAAI,CAAC2B,IAAI,KAAKC,aAAM,CAACG,IAAI,EAAE;QAC7B,IAAAC,uBAAc,EAAChC,IAAI,EAAEX,SAAS,EAAEkC,oBAAoB,CAAC;MACvD,CAAC,MAAM,IAAIvB,IAAI,CAAC2B,IAAI,KAAKC,aAAM,CAACK,IAAI,IAAIjC,IAAI,CAAC2B,IAAI,KAAKC,aAAM,CAACM,IAAI,EAAE;QACjE,IAAAC,oBAAW,EAACnC,IAAI,EAAEX,SAAS,EAAEkC,oBAAoB,CAAC;MACpD,CAAC,MAAM,IAAIvB,IAAI,CAAC2B,IAAI,KAAKC,aAAM,CAACQ,IAAI,EAAE;QACpC,IAAAC,8BAAqB,EAACrC,IAAI,EAAEX,SAAS,EAAEkC,oBAAoB,CAAC;MAC9D;MAEAjC,KAAK,CAAC8B,SAAS,EAAE;IACnB;IAEA,IAAI,CAAC7C,QAAQ,CAACoC,OAAO,CAAC,IAAI,CAAC;;IAE3B;IACA,KAAK,IAAI1B,GAAC,GAAG,CAAC,EAAEA,GAAC,GAAGK,KAAK,CAACU,IAAI,CAACd,MAAM,EAAED,GAAC,EAAE,EAAE;MAC1CI,SAAS,GAAGC,KAAK,CAACU,IAAI,CAACf,GAAC,CAAC;MAEzB,IAAII,SAAS,CAACG,KAAK,EAAE;QACnBH,SAAS,CAACiD,MAAM,EAAE;MACpB;IACF;EACF;;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;EACEb,YAAY,CAAC/C,EAAE,EAAEiD,IAAI,EAAEd,WAAW,EAAE;IAClC,IAAIxB,SAAS,GAAGX,EAAE,CAACsB,IAAI,CAACtB,EAAE,CAACsB,IAAI,CAACd,MAAM,GAAG,CAAC,CAAC;IAE3C,IACE,CAACG,SAAS,IACVA,SAAS,CAACwB,WAAW,KAAKA,WAAW,IACrCxB,SAAS,CAAC2B,MAAM,CAAC9B,MAAM,GAAG,MAAM,EAChC;MACAG,SAAS,GACP,IAAI,CAACb,gBAAgB,CAAC+D,GAAG,EAAE,IAC3B,IAAIC,0BAAiB,CACnB,IAAI,CAACjE,QAAQ,CAACG,EAAE,EAChB,IAAI,CAACD,eAAe,EACpB,IAAI,CAACF,QAAQ,CAACqB,KAAK,CAAC6C,YAAY,CACjC;MACHpD,SAAS,CAACwB,WAAW,GAAGA,WAAW;MACnCxB,SAAS,CAACqD,KAAK,CAACf,IAAI,CAAC;MACrBjD,EAAE,CAACsB,IAAI,CAACsB,IAAI,CAACjC,SAAS,CAAC;IACzB;IAEAA,SAAS,CAACG,KAAK,GAAG,IAAI;IAEtB,OAAOH,SAAS;EAClB;AACF;AAAC;AAEDsD,sBAAa,CAACC,cAAc,CAAC,UAAU,EAAExE,gBAAgB,CAAC"}