{"version":3,"file":"Loader.js","names":["MAX_PROGRESS","rgxExtractUrlHash","ResourceLoader","constructor","baseUrl","concurrency","progress","loading","defaultQueryString","_beforeMiddleware","_afterMiddleware","_resourcesParsing","_boundLoadResource","r","d","_loadResource","_queue","async","queue","pause","resources","onProgress","Signal","onError","onLoad","onStart","onComplete","i","_defaultBeforeMiddleware","length","pre","_defaultAfterMiddleware","use","add","name","url","options","cb","Array","isArray","callback","key","Error","parentResource","_prepareUrl","Resource","onAfterMiddleware","once","parent","incompleteChildren","children","isComplete","push","fullChunk","progressChunk","eachChunk","fn","reset","kill","k","res","_onLoadBinding","detach","isLoading","abort","destroy","loadAsync","Promise","resolve","reject","load","idle","_onStart","_onComplete","numTasks","_tasks","chunk","data","resume","parsedUrl","parseUri","strictMode","result","protocol","path","indexOf","lastIndexOf","charAt","hash","exec","substr","resource","dequeue","_dequeue","eachSeries","next","call","_onLoad","dispatch","Math","min","error","splice","LoaderPreStatic","LoaderUseStatic"],"sources":["../../src/resource/Loader.js"],"sourcesContent":["import Signal from \"mini-signals\";\nimport parseUri from \"parse-uri\";\nimport * as async from \"./async\";\nimport Resource from \"./Resource\";\n\nconst MAX_PROGRESS = 100;\nconst rgxExtractUrlHash = /(#[\\w-]+)?$/;\n\nexport default class ResourceLoader {\n  constructor(baseUrl = \"\", concurrency = 10) {\n    this.baseUrl = baseUrl;\n    this.progress = 0;\n    this.loading = false;\n    this.defaultQueryString = \"\";\n    this._beforeMiddleware = [];\n    this._afterMiddleware = [];\n    this._resourcesParsing = [];\n    this._boundLoadResource = (r, d) => this._loadResource(r, d);\n    this._queue = async.queue(this._boundLoadResource, concurrency);\n    this._queue.pause();\n\n    this.resources = {};\n    this.onProgress = new Signal();\n    this.onError = new Signal();\n    this.onLoad = new Signal();\n    this.onStart = new Signal();\n    this.onComplete = new Signal();\n\n    for (let i = 0; i < ResourceLoader._defaultBeforeMiddleware.length; ++i) {\n      this.pre(ResourceLoader._defaultBeforeMiddleware[i]);\n    }\n\n    for (let i = 0; i < ResourceLoader._defaultAfterMiddleware.length; ++i) {\n      this.use(ResourceLoader._defaultAfterMiddleware[i]);\n    }\n  }\n\n  add(name, url, options, cb) {\n    if (Array.isArray(name)) {\n      for (let i = 0; i < name.length; ++i) {\n        this.add(name[i]);\n      }\n\n      return this;\n    }\n\n    // if an object is passed instead of params\n    if (typeof name === \"object\") {\n      cb = url || name.callback || name.onComplete;\n      options = name;\n      url = name.url;\n      name = name.name || name.key || name.url;\n    }\n\n    if (this.resources[name]) {\n      return;\n    }\n\n    // case where no name is passed shift all args over by one.\n    if (typeof url !== \"string\") {\n      cb = options;\n      options = url;\n      url = name;\n    }\n\n    // now that we shifted make sure we have a proper url.\n    if (typeof url !== \"string\") {\n      throw new Error(\"No url passed to add resource to loader.\");\n    }\n\n    // options are optional so people might pass a function and no options\n    if (typeof options === \"function\") {\n      cb = options;\n      options = null;\n    }\n\n    // if loading already you can only add resources that have a parent.\n    if (this.loading && (!options || !options.parentResource)) {\n      throw new Error(\"Cannot add resources the loader is running.\");\n    }\n\n    url = this._prepareUrl(url);\n    this.resources[name] = new Resource(name, url, options);\n\n    if (typeof cb === \"function\") {\n      this.resources[name].onAfterMiddleware.once(cb);\n    }\n\n    // if actively loading, make sure to adjust progress chunks for that parent and its children\n    if (this.loading) {\n      const parent = options.parentResource;\n      const incompleteChildren = [];\n\n      for (let i = 0; i < parent.children.length; ++i) {\n        if (!parent.children[i].isComplete) {\n          incompleteChildren.push(parent.children[i]);\n        }\n      }\n\n      const fullChunk = parent.progressChunk * (incompleteChildren.length + 1); // +1 for parent\n      const eachChunk = fullChunk / (incompleteChildren.length + 2); // +2 for parent & new child\n\n      parent.children.push(this.resources[name]);\n      parent.progressChunk = eachChunk;\n\n      for (let i = 0; i < incompleteChildren.length; ++i) {\n        incompleteChildren[i].progressChunk = eachChunk;\n      }\n\n      this.resources[name].progressChunk = eachChunk;\n    }\n\n    this._queue.push(this.resources[name]);\n    return this;\n  }\n\n  pre(fn) {\n    this._beforeMiddleware.push(fn);\n    return this;\n  }\n\n  use(fn) {\n    this._afterMiddleware.push(fn);\n    return this;\n  }\n\n  reset() {\n    this.progress = 0;\n    this.loading = false;\n\n    this._queue.kill();\n    this._queue.pause();\n\n    for (const k in this.resources) {\n      const res = this.resources[k];\n      if (res._onLoadBinding) res._onLoadBinding.detach();\n      if (res.isLoading) res.abort();\n      delete this.resources[k];\n    }\n\n    this.resources = {};\n    return this;\n  }\n\n  destroy() {\n    this.progress = 0;\n    this.loading = false;\n\n    this._queue.kill();\n    this._queue.pause();\n\n    for (const key in this.resources) {\n      const res = this.resources[key];\n      if (res.destroy) res.destroy();\n      delete this.resources[key];\n    }\n\n    this.baseUrl = \"\";\n    this.defaultQueryString = \"\";\n    this._beforeMiddleware = null;\n    this._afterMiddleware = null;\n    this._resourcesParsing = null;\n    this._boundLoadResource = null;\n    this._queue = null;\n    this.resources = null;\n    this.onProgress = null;\n    this.onLoad = null;\n    this.onError = null;\n    this.onStart = null;\n    this.onComplete = null;\n  }\n\n  loadAsync() {\n    return new Promise((resolve, reject) => {\n      this.load(resolve);\n    });\n  }\n\n  load(cb) {\n    if (typeof cb === \"function\") this.onComplete.once(cb);\n    if (this.loading) return this;\n\n    if (this._queue.idle()) {\n      this._onStart();\n      this._onComplete();\n    } else {\n      const numTasks = this._queue._tasks.length;\n      const chunk = MAX_PROGRESS / numTasks;\n\n      for (let i = 0; i < this._queue._tasks.length; ++i) {\n        this._queue._tasks[i].data.progressChunk = chunk;\n      }\n\n      this._onStart();\n      this._queue.resume();\n    }\n\n    return this;\n  }\n\n  get concurrency() {\n    return this._queue.concurrency;\n  }\n\n  set concurrency(concurrency) {\n    this._queue.concurrency = concurrency;\n  }\n\n  _prepareUrl(url) {\n    const parsedUrl = parseUri(url, { strictMode: true });\n    let result;\n\n    // absolute url, just use it as is.\n    if (parsedUrl.protocol || !parsedUrl.path || url.indexOf(\"//\") === 0) {\n      result = url;\n    }\n    // if baseUrl doesn't end in slash and url doesn't start with slash, then add a slash inbetween\n    else if (\n      this.baseUrl.length &&\n      this.baseUrl.lastIndexOf(\"/\") !== this.baseUrl.length - 1 &&\n      url.charAt(0) !== \"/\"\n    ) {\n      result = `${this.baseUrl}/${url}`;\n    } else {\n      result = this.baseUrl + url;\n    }\n\n    // if we need to add a default querystring, there is a bit more work\n    if (this.defaultQueryString) {\n      const hash = rgxExtractUrlHash.exec(result)[0];\n      result = result.substr(0, result.length - hash.length);\n\n      if (result.indexOf(\"?\") !== -1) {\n        result += `&${this.defaultQueryString}`;\n      } else {\n        result += `?${this.defaultQueryString}`;\n      }\n\n      result += hash;\n    }\n\n    return result;\n  }\n\n  _loadResource(resource, dequeue) {\n    resource._dequeue = dequeue;\n\n    async.eachSeries(\n      this._beforeMiddleware,\n      (fn, next) => {\n        fn.call(this, resource, () => {\n          next(resource.isComplete ? {} : null);\n        });\n      },\n      () => {\n        if (resource.isComplete) {\n          this._onLoad(resource);\n        } else {\n          resource._onLoadBinding = resource.onComplete.once(\n            this._onLoad,\n            this\n          );\n          resource.load();\n        }\n      },\n      true\n    );\n  }\n\n  _onStart() {\n    this.progress = 0;\n    this.loading = true;\n    this.onStart.dispatch(this);\n  }\n\n  _onComplete() {\n    this.progress = MAX_PROGRESS;\n    this.loading = false;\n    this.onComplete.dispatch(this, this.resources);\n  }\n\n  _onLoad(resource) {\n    resource._onLoadBinding = null;\n    this._resourcesParsing.push(resource);\n    resource._dequeue();\n\n    async.eachSeries(\n      this._afterMiddleware,\n      (fn, next) => {\n        fn.call(this, resource, next);\n      },\n      () => {\n        resource.onAfterMiddleware.dispatch(resource);\n\n        this.progress = Math.min(\n          MAX_PROGRESS,\n          this.progress + resource.progressChunk\n        );\n        this.onProgress.dispatch(this, resource);\n\n        if (resource.error) {\n          this.onError.dispatch(resource.error, this, resource);\n        } else {\n          this.onLoad.dispatch(this, resource);\n        }\n\n        this._resourcesParsing.splice(\n          this._resourcesParsing.indexOf(resource),\n          1\n        );\n\n        // do completion check\n        if (this._queue.idle() && this._resourcesParsing.length === 0) {\n          this._onComplete();\n        }\n      },\n      true\n    );\n  }\n}\n\nResourceLoader._defaultBeforeMiddleware = [];\nResourceLoader._defaultAfterMiddleware = [];\n\nResourceLoader.pre = function LoaderPreStatic(fn) {\n  ResourceLoader._defaultBeforeMiddleware.push(fn);\n  return ResourceLoader;\n};\n\nResourceLoader.use = function LoaderUseStatic(fn) {\n  ResourceLoader._defaultAfterMiddleware.push(fn);\n  return ResourceLoader;\n};\n"],"mappings":"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"}