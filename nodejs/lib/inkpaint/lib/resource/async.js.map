{"version":3,"file":"async.js","names":["_noop","eachSeries","array","iterator","callback","deferNext","i","len","length","next","err","setTimeout","onlyOnce","fn","onceWrapper","Error","callFn","apply","arguments","queue","worker","concurrency","workers","q","_tasks","saturated","unsaturated","buffer","empty","drain","error","started","paused","push","data","_insert","kill","unshift","process","task","shift","_next","running","idle","pause","resume","w","insertAtFront","item"],"sources":["../../src/resource/async.js"],"sourcesContent":["function _noop() {}\n\nexport function eachSeries(array, iterator, callback, deferNext) {\n  let i = 0;\n  const len = array.length;\n\n  (function next(err) {\n    if (err || i === len) {\n      if (callback) {\n        callback(err);\n      }\n\n      return;\n    }\n\n    if (deferNext) {\n      setTimeout(() => {\n        iterator(array[i++], next);\n      }, 1);\n    } else {\n      iterator(array[i++], next);\n    }\n  })();\n}\n\nfunction onlyOnce(fn) {\n  return function onceWrapper() {\n    if (fn === null) {\n      throw new Error(\"Callback was already called.\");\n    }\n\n    const callFn = fn;\n\n    fn = null;\n    callFn.apply(this, arguments);\n  };\n}\n\nexport function queue(worker, concurrency) {\n  if (concurrency == null) {\n    concurrency = 1;\n  } else if (concurrency === 0) {\n    throw new Error(\"Concurrency must not be zero\");\n  }\n\n  let workers = 0;\n  const q = {\n    _tasks: [],\n    concurrency,\n    saturated: _noop,\n    unsaturated: _noop,\n    buffer: concurrency / 4,\n    empty: _noop,\n    drain: _noop,\n    error: _noop,\n    started: false,\n    paused: false,\n    push(data, callback) {\n      _insert(data, false, callback);\n    },\n    kill() {\n      workers = 0;\n      q.drain = _noop;\n      q.started = false;\n      q._tasks = [];\n    },\n    unshift(data, callback) {\n      _insert(data, true, callback);\n    },\n    process() {\n      while (!q.paused && workers < q.concurrency && q._tasks.length) {\n        const task = q._tasks.shift();\n\n        if (q._tasks.length === 0) {\n          q.empty();\n        }\n\n        workers += 1;\n\n        if (workers === q.concurrency) {\n          q.saturated();\n        }\n\n        worker(task.data, onlyOnce(_next(task)));\n      }\n    },\n    length() {\n      return q._tasks.length;\n    },\n    running() {\n      return workers;\n    },\n    idle() {\n      return q._tasks.length + workers === 0;\n    },\n    pause() {\n      if (q.paused === true) {\n        return;\n      }\n\n      q.paused = true;\n    },\n    resume() {\n      if (q.paused === false) {\n        return;\n      }\n\n      q.paused = false;\n      for (let w = 1; w <= q.concurrency; w++) {\n        q.process();\n      }\n    }\n  };\n\n  function _insert(data, insertAtFront, callback) {\n    if (callback != null && typeof callback !== \"function\") {\n      throw new Error(\"task callback must be a function\");\n    }\n\n    q.started = true;\n\n    if (data == null && q.idle()) {\n      setTimeout(() => q.drain(), 1);\n      return;\n    }\n\n    const item = {\n      data,\n      callback: typeof callback === \"function\" ? callback : _noop\n    };\n\n    if (insertAtFront) {\n      q._tasks.unshift(item);\n    } else {\n      q._tasks.push(item);\n    }\n\n    setTimeout(() => q.process(), 1);\n  }\n\n  function _next(task) {\n    return function next() {\n      workers -= 1;\n\n      task.callback.apply(task, arguments);\n\n      if (arguments[0] != null) {\n        q.error(arguments[0], task.data);\n      }\n\n      if (workers <= q.concurrency - q.buffer) {\n        q.unsaturated();\n      }\n\n      if (q.idle()) {\n        q.drain();\n      }\n\n      q.process();\n    };\n  }\n\n  return q;\n}\n"],"mappings":"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"}